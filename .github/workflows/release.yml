name: Create Release With Build Artifacts

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.1.0)'
        required: true

permissions:
  contents: write
  packages: write

jobs:
  wait-for-builds:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Wait for build workflows to complete
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            console.log(`Waiting for builds for tag: ${tag}`);

            const expectedWorkflows = [
              'Build Linux Packages',
              'Build Snap',
              'Build Flatpak'
            ];

            // Give workflows time to start
            await new Promise(resolve => setTimeout(resolve, 30000));

            // Poll for workflow completion (max 2 hours)
            const maxAttempts = 60;
            for (let i = 0; i < maxAttempts; i++) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head_sha: context.sha,
              });

              console.log(`Attempt ${i + 1}: Found ${runs.data.workflow_runs.length} workflows`);

              const buildWorkflows = runs.data.workflow_runs.filter(r =>
                expectedWorkflows.includes(r.name)
              );

              console.log(`Build workflows found: ${buildWorkflows.map(r => r.name).join(', ')}`);

              if (buildWorkflows.length >= expectedWorkflows.length) {
                const allComplete = buildWorkflows.every(r => r.status === 'completed');
                const allSuccess = buildWorkflows.every(r => r.conclusion === 'success');

                console.log(`Status: ${buildWorkflows.map(r => `${r.name}:${r.status}:${r.conclusion}`).join(', ')}`);

                if (allComplete) {
                  if (allSuccess) {
                    console.log('âœ… All builds succeeded!');
                    return;
                  } else {
                    throw new Error(`âŒ Some builds failed: ${buildWorkflows.filter(r => r.conclusion !== 'success').map(r => r.name).join(', ')}`);
                  }
                }
              }

              if (i < maxAttempts - 1) {
                await new Promise(resolve => setTimeout(resolve, 120000)); // Wait 2 minutes
              }
            }

            throw new Error('â±ï¸ Build workflows did not complete within 2 hours');

  create-release:
    needs: wait-for-builds
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Download Linux packages artifacts
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build-linux-packages.yml
          name: linux-packages
          path: artifacts/linux-packages
          commit: ${{ github.sha }}
          workflow_conclusion: success
          search_artifacts: true
          if_no_artifact_found: fail

      - name: Download Snap artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build-snap.yml
          name: snap-package
          path: artifacts/snap
          commit: ${{ github.sha }}
          workflow_conclusion: success
          search_artifacts: true
          if_no_artifact_found: fail

      - name: Download Flatpak artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build-flatpak.yml
          name: flatpak-bundle
          path: artifacts/flatpak
          commit: ${{ github.sha }}
          workflow_conclusion: success
          search_artifacts: true
          if_no_artifact_found: fail

      - name: Prepare release files
        run: |
          mkdir -p release
          VERSION=${{ steps.version.outputs.version }}

          echo "ðŸ“¦ Collecting artifacts..."

          # Copy DEB package
          find artifacts/linux-packages -name "*.deb" -exec cp {} release/ \;

          # Copy RPM package
          find artifacts/linux-packages -name "*.rpm" -exec cp {} release/ \;

          # Copy AppImage
          find artifacts/linux-packages -name "*.AppImage" -exec cp {} release/ \;

          # Copy Snap package
          find artifacts/snap -name "*.snap" -exec cp {} release/ \;

          # Copy Flatpak bundle
          find artifacts/flatpak -name "*.flatpak" -exec cp {} release/ \;

          # Generate checksums
          cd release
          sha256sum * > SHA256SUMS

          echo "ðŸ“¦ Release artifacts:"
          ls -lah
          cd ..

      - name: Create release notes
        id: release_notes
        run: |
          RELEASE_DATE=$(date -u +'%Y-%m-%d')
          cat > RELEASE_NOTES.md << 'EOF'
          # Proton Drive Linux ${{ steps.version.outputs.version }}

          **Release Date:** $RELEASE_DATE

          An unofficial Linux desktop client for Proton Drive, built with Tauri.

          ## Downloads

          | Format | File | Description |
          |--------|------|-------------|
          | DEB | `proton-drive_*.deb` | Debian, Ubuntu, Linux Mint |
          | RPM | `proton-drive-*.rpm` | Fedora, RHEL, CentOS, openSUSE |
          | AppImage | `proton-drive_*.AppImage` | Universal Linux (portable) |
          | Snap | `proton-drive_*.snap` | Snap-enabled distributions |
          | Flatpak | `proton-drive.flatpak` | Flatpak-enabled distributions |

          ## Installation

          ### Debian/Ubuntu
          ```bash
          sudo apt install ./proton-drive_*.deb
          ```

          ### Fedora/RHEL
          ```bash
          sudo dnf install ./proton-drive-*.rpm
          ```

          ### AppImage (Portable)
          ```bash
          chmod +x proton-drive_*.AppImage
          ./proton-drive_*.AppImage
          ```

          ### Snap
          ```bash
          sudo snap install --dangerous proton-drive_*.snap
          ```

          ### Flatpak
          ```bash
          flatpak install --user proton-drive.flatpak
          ```

          ## Checksums

          All files have SHA256 checksums available in `SHA256SUMS`.

          ## System Requirements

          - Linux x86_64
          - GTK 3.0+ and WebKitGTK
          - ~200MB disk space

          ## Issues

          Report issues at https://github.com/${{ github.repository }}/issues
          EOF
          sed -i "s/\$RELEASE_DATE/$RELEASE_DATE/g" RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release checksums
        uses: actions/upload-artifact@v4
        with:
          name: release-checksums
          path: release/SHA256SUMS
          retention-days: 90

  publish-aur:
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Generate PKGBUILD
        run: |
          mkdir -p aur
          cat > aur/PKGBUILD << EOF
          # Maintainer: DonnieDice <donniedice@protonmail.com>
          pkgname=proton-drive-bin
          pkgver=${{ steps.version.outputs.version }}
          pkgrel=1
          pkgdesc="Unofficial Proton Drive Linux desktop client (Tauri)"
          arch=('x86_64')
          url="https://github.com/${{ github.repository }}"
          license=('AGPL-3.0-or-later')
          depends=('webkit2gtk' 'gtk3' 'libayatana-appindicator' 'openssl')
          provides=('proton-drive')
          conflicts=('proton-drive')
          source=("\${pkgname}-\${pkgver}.deb::https://github.com/${{ github.repository }}/releases/download/v\${pkgver}/proton-drive_\${pkgver}_amd64.deb")
          sha256sums=('SKIP')

          package() {
            bsdtar -xf data.tar.* -C "\${pkgdir}/"
          }
          EOF

          cat > aur/.SRCINFO << EOF
          pkgbase = proton-drive-bin
          	pkgdesc = Unofficial Proton Drive Linux desktop client (Tauri)
          	pkgver = ${{ steps.version.outputs.version }}
          	pkgrel = 1
          	url = https://github.com/${{ github.repository }}
          	arch = x86_64
          	license = AGPL-3.0-or-later
          	depends = webkit2gtk
          	depends = gtk3
          	depends = libayatana-appindicator
          	depends = openssl
          	provides = proton-drive
          	conflicts = proton-drive
          	source = proton-drive-bin-${{ steps.version.outputs.version }}.deb::https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/proton-drive_${{ steps.version.outputs.version }}_amd64.deb
          	sha256sums = SKIP

          pkgname = proton-drive-bin
          EOF

      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: proton-drive-bin
          pkgbuild: aur/PKGBUILD
          commit_username: DonnieDice
          commit_email: donniedice@protonmail.com
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to v${{ steps.version.outputs.version }}"
          force_push: true
