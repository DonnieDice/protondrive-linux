name: Build WebClients (Web Only)

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-web:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Check if WebClients exists
        id: check_webclient
        run: |
          if [ -d "WebClients" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Clone WebClients if needed
        if: steps.check_webclient.outputs.exists == 'false'
        run: |
          echo "WebClients not found, cloning..."
          git clone --depth=1 https://github.com/ProtonMail/WebClients.git WebClients

      - name: Fix WebClients dependencies
        run: |
          cd WebClients
          
          cat > fix_deps.py << 'EOFPYTHON'
          import json
          from pathlib import Path
          
          for pkgfile in Path('.').rglob('package.json'):
              if 'node_modules' in str(pkgfile) or '.yarn' in str(pkgfile):
                  continue
              
              try:
                  with open(pkgfile, 'r') as f:
                      data = json.load(f)
                  
                  modified = False
                  
                  for deptype in ['dependencies', 'devDependencies', 'peerDependencies', 'optionalDependencies']:
                      if deptype in data:
                          for key in list(data[deptype].keys()):
                              if 'rowsncolumns' in key.lower():
                                  print(f"Removing {key} from {deptype}")
                                  del data[deptype][key]
                                  modified = True
                  
                  if modified:
                      with open(pkgfile, 'w') as f:
                          json.dump(data, f, indent=2)
                          f.write('\n')
              except Exception as e:
                  print(f"Error: {e}")
          
          print("Dependencies fixed!")
          EOFPYTHON
          
          python3 fix_deps.py
          rm -f yarn.lock
          cd ..

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'
          cache-dependency-path: WebClients/yarn.lock

      - name: Install dependencies
        run: |
          cd WebClients
          corepack enable
          yarn install

      - name: Build Proton Drive
        run: |
          cd WebClients
          yarn workspace proton-drive build
          
          # Verify build output
          if [ ! -d "applications/drive/dist" ]; then
            echo "❌ Build failed - dist directory not found"
            exit 1
          fi
          
          echo "✅ Build successful"
          ls -lah applications/drive/dist

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: proton-drive-web-build
          path: WebClients/applications/drive/dist/
          retention-days: 7

      - name: Create build summary
        run: |
          cd WebClients/applications/drive/dist
          echo "## Build Complete ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          du -sh .
          find . -maxdepth 2 -type f | head -20
          echo '```' >> $GITHUB_STEP_SUMMARY
